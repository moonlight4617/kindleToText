# 2025-10-29

## 実施内容

Kindle書籍OCR自動化ワークフローのPhase 4（OCR処理機能）を完了。

- OCR抽象インターフェースの設計・実装
- Yomitoku OCRエンジンの実装
- Tesseract OCRエンジンの実装（フォールバック）
- エンジン選択・切り替え機能の実装

### 目的・背景

前日（2025-10-28）にPhase 2（スクリーンショット機能）とPhase 3（画像前処理機能）を完了し、画像の取得と前処理が整った。本日は、それらの画像からテキストを抽出するOCR機能を実装する。

Yomitoku（日本語特化）とTesseract（汎用）の2つのOCRエンジンをサポートし、柔軟に切り替えられる設計を目指した。将来的に他のOCRエンジン（例：Azure Computer Vision、Google Cloud Vision）を追加できる拡張性も考慮。

### 所要時間／作業時間の見積もりと実績

- **見積もり**: 10時間（Phase 4全体）
- **実績**: 約2時間
  - OCRインターフェース設計・実装: 約30分
  - Yomitokuエンジン実装: 約40分
  - Tesseractエンジン実装: 約30分
  - テスト作成・実行: 約20分

※見積もりより大幅に早く完了。明確な設計パターン（抽象クラス+ファクトリー）とモックベースのテストにより効率的に実装できた。

### 詳細な実施内容

#### 4.1 OCR抽象インターフェース ([src/ocr/ocr_interface.py](../../src/ocr/ocr_interface.py))

**データクラス定義**:
- `BoundingBox`: テキスト領域の境界ボックス
  - left, top, width, height, confidence
- `TextBlock`: 検出されたテキストブロック
  - text, bounding_box, confidence, block_type, font_size, is_bold
- `LayoutData`: レイアウト情報を含むOCR結果
  - full_text, blocks, page_width, page_height, language, average_confidence
- `OCRResult`: OCR処理結果
  - text, confidence, layout, engine_name, processing_time, success, error_message

**抽象インターフェース**:
- `OCRInterface(ABC)`: すべてのOCRエンジンの基底クラス
  - `initialize()`: エンジン初期化
  - `extract_text()`: テキスト抽出
  - `extract_with_layout()`: レイアウト情報付きテキスト抽出
  - `get_engine_name()`: エンジン名取得
  - `is_available()`: 利用可否チェック
  - `close()`: リソース解放（オプション）

**ファクトリーパターン**:
- `OCREngineFactory`: エンジンの登録と生成
  - `register_engine()`: エンジンクラスの登録
  - `create_engine()`: 名前からエンジン生成
  - `get_available_engines()`: 利用可能エンジンリスト

**エンジン選択ロジック**:
- `OCREngineSelector`: 優先順位に基づくエンジン自動選択
  - デフォルト優先順位: yomitoku → tesseract
  - フォールバック機能
  - 設定による優先順位カスタマイズ

**ヘルパー関数**:
- `create_default_ocr_engine()`: デフォルトエンジンの簡単作成

#### 4.2 Yomitokuエンジン ([src/ocr/yomitoku_engine.py](../../src/ocr/yomitoku_engine.py))

**実装内容**:
- YomitokuのDocumentAnalyzerをラッパー
- 設定項目:
  - `model_name`: モデル名（デフォルト: "yomitoku"）
  - `device`: 使用デバイス（"cpu" or "cuda"）
  - `confidence_threshold`: 信頼度閾値（デフォルト: 0.0）

**主要機能**:
- `initialize()`: DocumentAnalyzerの初期化
  - Yomitokuモジュールの動的インポート
  - GPU/CPU選択
- `extract_text()`: テキストのみ抽出
  - PIL Image → NumPy配列変換
  - Yomitoku実行
  - 平均信頼度計算
  - 処理時間計測
- `extract_with_layout()`: レイアウト情報付き抽出
  - テキストブロックの抽出
  - バウンディングボックス情報
  - 信頼度閾値によるフィルタリング

**エラーハンドリング**:
- モジュール未インストール時の適切なエラー
- 初期化失敗時の自動リトライ
- OCR失敗時のエラーメッセージ

**技術的特徴**:
- 遅延初期化（is_available()で事前チェック）
- リソース管理（close()でメモリ解放）
- 結果形式の柔軟な解析（複数の結果フォーマットに対応）

#### 4.3 Tesseractエンジン ([src/ocr/tesseract_engine.py](../../src/ocr/tesseract_engine.py))

**実装内容**:
- pytesseractのラッパー
- 設定項目:
  - `lang`: 言語コード（デフォルト: "jpn+eng"）
  - `tesseract_cmd`: Tesseract実行ファイルパス
  - `psm`: ページセグメンテーションモード（デフォルト: 3）
  - `oem`: OCRエンジンモード（デフォルト: 3）
  - `confidence_threshold`: 信頼度閾値

**主要機能**:
- `initialize()`: Tesseractの初期化確認
  - バージョン確認
  - 言語データの利用可否チェック
  - 警告メッセージ（言語データ未インストール時）
- `extract_text()`: テキスト抽出
  - `image_to_string()`: テキスト取得
  - `image_to_data()`: 信頼度情報取得
  - カスタムPSM/OEM設定
- `extract_with_layout()`: 詳細レイアウト情報
  - 単語レベルのバウンディングボックス
  - ブロック/段落/行/単語の階層構造
  - レベル情報によるblock_type判定

**技術的特徴**:
- 信頼度の正規化（Tesseractは0-100、内部は0.0-1.0）
- 信頼度-1（情報なし）の適切な処理
- 多言語対応（"+"区切りで複数言語指定可能）
- カスタム設定文字列の柔軟な構築

#### 4.4 ocrモジュールの統合 ([src/ocr/__init__.py](../../src/ocr/__init__.py))

すべてのクラスとヘルパー関数をエクスポート:
- データクラス（BoundingBox, TextBlock, LayoutData, OCRResult）
- インターフェース（OCRInterface）
- ファクトリー・セレクター（OCREngineFactory, OCREngineSelector）
- エンジン（YomitokuEngine, TesseractEngine）
- ヘルパー関数（create_default_ocr_engine）

#### 4.5 ユニットテスト作成

**test_ocr_interface.py** (21テスト):
- データクラスのテスト（6テスト）
  - BoundingBox作成・デフォルト値
  - TextBlock作成・デフォルト値
  - LayoutData作成・デフォルト値
  - OCRResult作成・レイアウト付き・失敗ケース
- OCREngineFactoryのテスト（4テスト）
  - エンジン登録
  - エンジン作成（成功/失敗）
  - 設定付き作成
  - 利用可能エンジンリスト取得
- OCREngineSelectorのテスト（5テスト）
  - デフォルト/カスタム優先順位
  - エンジン選択成功
  - エンジン利用不可・初期化失敗
- OCRInterfaceのテスト（2テスト）
  - 抽象クラスの直接インスタンス化不可
  - 具象クラスの実装

**test_ocr_engines.py** (26テスト):
- YomitokuEngineのテスト（11テスト）
  - 初期化（デフォルト/カスタム）
  - エンジン名取得
  - 利用可否チェック（True/False）
  - 初期化（成功/失敗）
  - テキスト抽出（未初期化/成功）
  - レイアウト付き抽出成功
  - リソース解放
- TesseractEngineのテスト（15テスト）
  - 初期化（デフォルト/カスタム）
  - エンジン名取得
  - 利用可否チェック（True/False）
  - 初期化（成功/失敗）
  - テキスト抽出（未初期化/成功）
  - レイアウト付き抽出成功
  - リソース解放
  - 平均信頼度計算
  - 信頼度閾値フィルタリング
- エンジン統合テスト（2テスト）
  - 自動初期化機能

**結果**: 47テスト全て合格 ✅

### 課題・詰まった点と解決策

#### 1. Yomitokuの結果フォーマットの不明確さ
**課題**: Yomitokuの公式ドキュメントが少なく、OCR結果の正確なデータ構造が不明。実際にインストールして試すことができない環境での実装。

**解決策**:
- 柔軟な結果解析ロジックを実装
- `hasattr()`と`isinstance()`を使って複数のフォーマットに対応
- テストはモックを使用し、想定される形式をカバー
- 実際の利用時にエラーが出ても対応できるエラーハンドリング

#### 2. OCRエンジンのモックテスト
**課題**: 実際のOCRライブラリ（Yomitoku、Tesseract）をテスト環境にインストールせずにテストを実行したい。

**解決策**:
- `unittest.mock`の`patch`デコレータで外部依存をモック化
- `sys.modules`をパッチしてモジュールインポートをシミュレート
- モックオブジェクトで期待される動作を再現
- テストの独立性を保ちつつ、インターフェースの正しさを検証

#### 3. Tesseractの信頼度の正規化
**課題**: Tesseractは信頼度を0-100のスケールで返すが、内部では0.0-1.0で統一したい。また、信頼度情報がない場合は-1を返す。

**解決策**:
- 信頼度取得時に100で割って0.0-1.0に正規化
- -1の場合は0.0として扱う（または除外）
- 平均信頼度計算時に-1を除外するロジック

#### 4. 抽象クラスの設計
**課題**: すべてのOCRエンジンで共通のインターフェースを強制しつつ、エンジン固有の機能も許容したい。

**解決策**:
- `abc.ABC`を使用した抽象基底クラス
- 必須メソッドは`@abstractmethod`で強制
- オプションメソッド（`close()`）はデフォルト実装を提供
- エンジン固有の設定は`config`辞書で柔軟に対応

### 使用したツール・技術要素のメモ

#### OCRライブラリ
- **Yomitoku**: 日本語特化OCR（メインエンジン）
  - DocumentAnalyzerクラス
  - 高精度な日本語認識
  - GPU対応
- **pytesseract**: Tesseract OCRのPythonラッパー
  - `image_to_string()`: テキスト抽出
  - `image_to_data()`: レイアウト情報取得
  - `get_tesseract_version()`: バージョン確認
  - `get_languages()`: 利用可能言語リスト

#### デザインパターン
- **抽象ファクトリーパターン**: OCREngineFactory
- **ストラテジーパターン**: OCRInterface（エンジン切り替え）
- **データクラス**: 型安全なデータ構造
- **ファクトリーメソッドパターン**: create_default_ocr_engine()

#### テスト技術
- **モッキング**: `unittest.mock.patch`
  - 外部ライブラリのモック化
  - `sys.modules`のパッチ
  - メソッド・属性の動的モック
- **パラメータ化テスト**: 複数の設定パターンをテスト
- **MagicMock**: 柔軟なモックオブジェクト作成

#### Python機能
- **ABC（抽象基底クラス）**: `abc.ABC`, `@abstractmethod`
- **型ヒント**: Optional, List, Tuple, dict
- **データクラス**: `@dataclass`デコレータ
- **動的インポート**: `importlib`, try-except import
- **プロパティアクセス**: `hasattr()`, `getattr()`

### 学び／気づき

#### 1. 抽象クラスの威力
ABCを使った抽象クラス設計により、すべてのOCRエンジンが同じインターフェースを実装することを強制できた。これにより、エンジンを切り替えても同じコードで動作する保証が得られる。

#### 2. ファクトリーパターンの実用性
OCREngineFactoryにより、文字列（エンジン名）からエンジンインスタンスを生成できる。設定ファイルでエンジンを指定するだけで切り替えられる柔軟性が得られた。

#### 3. モックテストの重要性
実際のOCRライブラリをインストールせずにテストできることで、CI/CD環境での高速テストが可能。また、エッジケース（初期化失敗、エラー発生等）も簡単にテストできる。

#### 4. 信頼度情報の標準化
異なるOCRエンジンが異なる信頼度スケール（0-100 vs 0.0-1.0）を使用するため、内部で標準化することが重要。これにより、エンジン間の比較や閾値設定が容易になる。

#### 5. 遅延初期化の利点
`is_available()`でチェックしてから`initialize()`を呼ぶ設計により、利用できないエンジンでインスタンス化エラーが発生しない。複数のエンジンから自動選択する際に有用。

#### 6. データクラスの効率性
`@dataclass`を使うことで、`__init__`, `__repr__`, `__eq__`などが自動生成され、ボイラープレートコードを大幅に削減できた。

#### 7. レイアウト情報の価値
単純なテキスト抽出だけでなく、レイアウト情報（バウンディングボックス、ブロックタイプ）を保持することで、将来的な見出し検出や段落整形が可能になる。

## 成果物

### 実装コード（3ファイル、約900行）
1. [src/ocr/ocr_interface.py](../../src/ocr/ocr_interface.py) - OCRインターフェース（約280行）
2. [src/ocr/yomitoku_engine.py](../../src/ocr/yomitoku_engine.py) - Yomitokuエンジン（約330行）
3. [src/ocr/tesseract_engine.py](../../src/ocr/tesseract_engine.py) - Tesseractエンジン（約290行）

### テストコード（2ファイル、約700行）
1. [tests/test_ocr_interface.py](../../tests/test_ocr_interface.py) - インターフェーステスト（21テスト）
2. [tests/test_ocr_engines.py](../../tests/test_ocr_engines.py) - エンジンテスト（26テスト）

### モジュール初期化ファイル
- [src/ocr/__init__.py](../../src/ocr/__init__.py) - ocrモジュール統合

### テスト結果
```
tests/test_ocr_interface.py: 21 passed (100%)
tests/test_ocr_engines.py: 26 passed (100%)
合計: 47 passed
```

### ドキュメント更新
- [implementation_plan.md](../../implementation_plan.md) - Phase 4の完了マーク追加

## 進捗状況

### 完了フェーズ
- ✅ **Phase 0**: 開発環境セットアップ（100%）
- ✅ **Phase 1**: 基盤機能実装（100%）
- ✅ **Phase 2**: スクリーンショット機能（100%）
- ✅ **Phase 3**: 画像前処理機能（100%）
- ✅ **Phase 4**: OCR処理機能（100%）

### 全体進捗
- **5 / 11 フェーズ完了** (45%)
- **推定残り工数**: 32時間

### テスト統計
- **Phase 0-1**: 57テスト合格
- **Phase 2**: 42テスト合格
- **Phase 3**: 58テスト合格
- **Phase 4**: 47テスト合格
- **累計**: 204テスト合格（100%）

## 次に実施する予定のタスク

### Phase 5: テキスト出力機能（推定4時間）

1. **テキスト整形モジュール** (`src/output/formatter.py`)
   - テキストクリーニング機能
   - 見出し整形機能（OCRレイアウト情報を活用）
   - 段落整理機能
   - 不要文字除去（ハイフン結合、改行の正規化）

2. **テキスト書き込みモジュール** (`src/output/text_writer.py`)
   - テキストファイル作成
   - テキスト追記機能
   - メタデータ追加（書籍情報、処理日時等）
   - Markdown形式出力対応

3. **ユニットテスト作成**
   - outputモジュールのテスト
   - ファイル出力確認

### その後の予定
- Phase 6: 状態管理機能（推定6時間）
- Phase 7: メイン制御機能（推定8時間）
- Phase 8: 実機テスト・調整（推定10時間）

## その他メモ

### 実装の特徴

#### OCRインターフェース
- **拡張性**: 新しいOCRエンジンの追加が容易（インターフェース実装+ファクトリー登録）
- **柔軟性**: 設定による動的なエンジン選択
- **堅牢性**: エンジン利用不可時の自動フォールバック
- **詳細情報**: レイアウト情報、信頼度、処理時間の記録

#### Yomitokuエンジン
- **日本語特化**: 高精度な日本語認識
- **GPU対応**: CUDAデバイスの利用可能
- **柔軟な解析**: 複数の結果フォーマットに対応
- **信頼度フィルタ**: 低信頼度テキストの除外

#### Tesseractエンジン
- **汎用性**: 多言語対応（100以上の言語）
- **詳細レイアウト**: 単語・行・段落・ブロックレベルの情報
- **カスタマイズ**: PSM/OEMモードの細かい設定
- **フォールバック**: Yomitoku利用不可時のバックアップ

### 技術的なハイライト
- **47テストケース**: 包括的なテストカバレッジ
- **抽象化**: 共通インターフェースによる実装の統一
- **ファクトリーパターン**: 動的なエンジン生成
- **モックテスト**: 外部依存なしの高速テスト
- **型安全**: データクラスと型ヒントの活用

### 設計判断

#### なぜファクトリーパターンを採用したか
設定ファイルでエンジン名（文字列）を指定するだけで、適切なエンジンインスタンスを生成できる。これにより、コードを変更せずに設定だけでエンジンを切り替えられる。

#### なぜ2つのOCRエンジンをサポートするか
- **Yomitoku**: 日本語精度が高いが、インストールが複雑
- **Tesseract**: 精度は劣るが、インストールが容易で広く利用されている
- フォールバック機能により、どちらか一方でも動作する

#### なぜレイアウト情報を保持するか
単純なテキスト抽出だけでなく、バウンディングボックスやブロックタイプを保持することで、Phase 5での見出し検出や段落整形が可能になる。NotebookLMでの要約精度向上にも寄与する。

### 今後の課題
1. **実画像でのOCR精度評価**: テストデータによる精度検証
2. **Yomitokuの実環境テスト**: 実際にYomitokuをインストールして動作確認
3. **パフォーマンス最適化**: 大量ページ処理時の速度向上
4. **見出し検出精度**: レイアウト情報を活用した見出し検出ロジックの調整

### NotebookLM連携に向けて
Phase 5でMarkdown形式での出力を実装し、見出し構造を持ったテキストファイルを生成する予定。OCRで取得したレイアウト情報を活用することで、書籍の構造を保持したテキスト化が可能になる。

### 開発効率の向上要因
1. **明確な抽象化**: インターフェース駆動設計による実装の迷いなし
2. **モックテスト**: 外部ライブラリなしでの高速開発サイクル
3. **データクラス**: ボイラープレートコードの削減
4. **ファクトリーパターン**: 拡張性の高い設計

---

**作業時間**: 約2時間
**作成ファイル数**: 6ファイル
**コード行数**: 約1,600行
**テスト合格数**: 47テスト（100%）
**累計テスト数**: 204テスト
**Phase完了**: 5/11 (45%)
