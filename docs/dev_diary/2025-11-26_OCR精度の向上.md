# 2025-11-26 OCR精度の向上

## 問題の概要

Kindleアプリからスクリーンショットを撮影し、OCR処理を行っているが、出力テキストに多くの誤字が含まれている。

### 現状の誤字率
- 推定: 10-20%程度
- 例: 「LLM」→「LIM」、「Transformer」→「Trandormes」など

## 原因分析

### 1. ImageProcessor初期化の問題（✅ 修正済み）
- **問題**: [main.py:91](../main.py#L91)で設定辞書を`ImageProcessor`に渡していたが、クラスが辞書を受け取れる設計になっていなかった
- **影響**: 画像前処理が正しく実行されていなかった
- **対応**: `ImageProcessor.__init__`を修正し、設定辞書を受け取れるように変更

### 2. 画像の品質問題
- **Kindleアプリの表示**:
  - 1ページ表示時: 左右に大きな黒い余白があり、OCR精度が低下
  - 2ページ表示時: 余白が減り、精度が向上したが、まだ誤字が多い
- **スクリーンショットの内容**:
  - ブラウザのツールバーやKindleのUIが含まれる
  - ページ番号、検索バーなど余計な要素が混入

### 3. 前処理パラメータの問題
- **二値化**: 適応的二値化（adaptive）を使用しているが、画面キャプチャには過剰な処理の可能性
- **コントラスト調整**: clip_limit=2.0は控えめな設定

### 4. OCRエンジンの限界
- **現在の設定**: Yomitoku（primary）+ Tesseract（fallback）
- **画面表示テキストの特性**: 紙の書籍と比べて、フォントレンダリングやアンチエイリアシングの影響を受けやすい

## 改善計画

### Phase 1: 前処理パラメータの最適化

#### 1.1 二値化の無効化
```yaml
preprocessing:
  binarization:
    enabled: false
```
**理由**: 画面キャプチャは既に十分な品質があり、二値化が精度を低下させている可能性

#### 1.2 コントラスト調整の強化
```yaml
preprocessing:
  contrast:
    clip_limit: 3.0  # 2.0 → 3.0
```

### Phase 2: OCRエンジンの比較

#### 2.1 Tesseractエンジンのテスト
```yaml
ocr:
  primary_engine: "tesseract"
  tesseract:
    config: "--psm 6 --oem 1"  # LSTM engine
```

#### 2.2 Yomitoku vs Tesseractの精度比較
- 同じページで両エンジンをテスト
- 誤字率を比較
- より精度の高いエンジンを選択

### Phase 3: 表示設定の最適化

#### 3.1 Kindle表示倍率の向上
- 100% → 150% または 200%
- より高解像度のスクリーンショットを取得
- 文字が大きくなり、OCR精度が向上する可能性

### Phase 4: 代替アプローチの検討

もし上記の改善で十分な精度が得られない場合:

#### 4.1 商用OCR APIの使用
- **Google Cloud Vision API**: 高精度、コストあり
- **Amazon Textract**: AWS統合、コストあり
- **Azure Computer Vision**: Microsoft統合、コストあり

#### 4.2 Kindle電子書籍データの直接抽出
- `.azw`や`.mobi`ファイルから直接テキストを抽出
- OCR不要で100%正確
- ただし、DRM保護とライセンスの問題あり

## 実施記録

### 2025-11-26 午前
- [x] ImageProcessor初期化の修正
- [x] 設定辞書対応の実装
- [x] trim_marginsの改善（黒い余白対応）
- [x] テストの実行と確認

### 2025-11-26 午後
- [x] 二値化の無効化テスト ✅ **大幅な精度向上を確認！**
- [ ] Tesseractエンジンの比較テスト（オプション）
- [ ] Kindle表示倍率の変更テスト（オプション）
- [x] 最適な設定の決定

#### テスト結果: 二値化の無効化

**実施コマンド**:
```bash
python main.py --title "LLM自作入門_no_binarization" --total-pages 3 --debug
```

**結果**: 🎉 **大成功！精度が大幅に向上**

**精度比較**:
- Before（二値化あり）: 誤字率 15-20%程度
- After（二値化なし）: 誤字率 **3-5%程度**

**改善例**:
| Before | After |
|--------|-------|
| 山口とは | LLM とは |
| 入間のような | 人間のような |
| 武大な量 | 膨大な量 |
| 武練された | 訓練された |
| Trandormes | Transformer |

**分析**:
- 画面キャプチャは既に十分な品質があるため、二値化が過剰処理となっていた
- グレースケール情報を保持することで、微妙なフォントの違いを正確に認識
- 適応的二値化は紙の書籍スキャンには有効だが、高品質な画面表示には不要

**結論**:
- 二値化の無効化により、目標とする精度を達成
- 現状の設定（Yomitoku + 二値化なし）で十分実用的
- Tesseractとの比較や表示倍率の変更は必要に応じて実施

## 参考情報

### 現在の設定ファイル
- [config/config.yaml](../../config/config.yaml)

### 関連ソースコード
- [src/preprocessor/image_processor.py](../../src/preprocessor/image_processor.py)
- [src/ocr/yomitoku_engine.py](../../src/ocr/yomitoku_engine.py)
- [src/ocr/tesseract_engine.py](../../src/ocr/tesseract_engine.py)
- [main.py](../../main.py)

### テストファイル
- [tests/test_image_processor.py](../../tests/test_image_processor.py)
- [tests/test_preprocessing_integration.py](../../tests/test_preprocessing_integration.py)
- [tests/test_trim_margins_improvement.py](../../tests/test_trim_margins_improvement.py)

## 結論

### 最終的な解決策

**二値化の無効化**により、OCR精度が大幅に向上しました（誤字率 15-20% → 3-5%）。

### 最適な設定

```yaml
preprocessing:
  binarization:
    enabled: false  # 画面キャプチャには不要

ocr:
  primary_engine: "yomitoku"  # 日本語OCRとして優秀
```

### 学んだこと

1. **画面キャプチャと紙のスキャンは異なる**
   - 画面表示は既に高品質なため、過度な前処理は逆効果
   - 二値化は紙のスキャンには有効だが、画面には不要

2. **グレースケール情報の重要性**
   - 微妙なフォントの違いや影を保持することで、認識精度が向上
   - 二値化により情報が失われていた

3. **設定の柔軟性の重要性**
   - 入力ソースに応じて前処理を調整できる設計が重要
   - ImageProcessorの設定辞書対応が功を奏した

### 今後の改善案（オプション）

もしさらに精度を上げたい場合:

1. Kindle表示倍率を上げる（150% or 200%）→ より大きな文字でOCR精度向上の可能性
2. Tesseractエンジンとの比較 → 場合によってはTesseractの方が精度が高い可能性
3. 商用OCR API（Google Cloud Vision等）→ コストはかかるが、ほぼ完璧な精度

### 推奨

**現状の設定（Yomitoku + 二値化なし）で十分実用的**です。残存する3-5%の誤字は、用途によっては許容範囲と考えられます。さらなる精度向上が必要な場合のみ、上記の改善案を検討してください。
