# 2025-12-01 Gemini AI Engine実装

## 背景

既存のOCRエンジン（Yomitoku、Tesseract、Google Cloud Vision）の精度に課題があり、より高精度な文字起こしが必要となった。
Gemini 1.5 Flashを使用して、スクリーンショット画像から直接テキストを抽出する機能を実装する。

## 目的

- Gemini APIを活用した高精度な日本語OCR機能の追加
- 既存のOCRエンジンアーキテクチャとの統合
- コスト効率の良いAIベースの文字起こし

## 実装計画

### 1. 依存関係の追加

**ファイル**: `requirements.txt`

追加パッケージ:
```
google-generativeai>=0.3.0
```

### 2. Gemini設定クラスの追加

**ファイル**: `src/config/settings.py`

新規追加クラス:
```python
@dataclass
class GeminiSettings:
    """Gemini AI OCR engine settings."""
    api_key: Optional[str] = None  # または環境変数から取得
    model: str = "gemini-1.5-flash"
    temperature: float = 0.0
    max_output_tokens: int = 8192
    prompt_template: str = "画像内のテキストを抽出してください。..."
```

既存の`OCRSettings`クラスへの追加:
```python
@dataclass
class OCRSettings:
    primary_engine: str = "gemini"  # 新しいデフォルト
    fallback_engine: str = "google_vision"
    # ...
    gemini: GeminiSettings = field(default_factory=GeminiSettings)
```

### 3. Gemini OCRエンジンの実装

**ファイル**: `src/ocr/gemini_engine.py`

実装内容:
- `OCRInterface`を継承した`GeminiEngine`クラス
- 画像をBase64エンコードしてGemini APIに送信
- レスポンスをパースして`OCRResult`形式に変換
- エラーハンドリング（APIエラー、レート制限など）

主要メソッド:
```python
class GeminiEngine(OCRInterface):
    def __init__(self, settings: GeminiSettings)
    def process_image(self, image_path: Path) -> OCRResult
    def _encode_image(self, image_path: Path) -> str
    def _parse_response(self, response) -> OCRResult
```

### 4. OCR Factoryへの登録

**ファイル**: `src/ocr/ocr_interface.py`

`OCREngineFactory`の`create()`メソッドに追加:
```python
elif engine_type == "gemini":
    from .gemini_engine import GeminiEngine
    return GeminiEngine(settings.ocr.gemini)
```

### 5. __init__.pyの更新

**ファイル**: `src/ocr/__init__.py`

エクスポートリストに追加:
```python
from .gemini_engine import GeminiEngine

__all__ = [
    # ...
    "GeminiEngine",
]
```

### 6. 設定ファイルの更新

**ファイル**: `config/config.example.yaml`

新しいセクションを追加:
```yaml
ocr:
  primary_engine: "gemini"
  fallback_engine: "google_vision"

  # Gemini AI Settings
  gemini:
    api_key: null  # または環境変数 GEMINI_API_KEY を使用
    model: "gemini-1.5-flash"
    temperature: 0.0
    max_output_tokens: 8192
    prompt_template: |
      この画像は書籍のページです。
      画像内のすべてのテキストを正確に抽出してください。

      要件:
      - 日本語の文字を正確に認識
      - レイアウトや段落構造を保持
      - 特殊文字や記号も含める
      - テキスト以外の説明は不要
```

### 7. テストコードの作成

**ファイル**: `tests/test_gemini_engine.py`

テスト項目:
- Geminiエンジンの初期化テスト
- 画像処理の正常系テスト
- APIエラーハンドリングのテスト
- 設定の読み込みテスト
- Base64エンコーディングのテスト

### 8. 既存コードへの影響

**影響を受けるファイル**:
- `src/config/settings.py` - GeminiSettings追加
- `src/ocr/ocr_interface.py` - Factory登録
- `src/ocr/__init__.py` - エクスポート追加
- `requirements.txt` - 依存関係追加
- `config/config.example.yaml` - 設定例追加

**互換性**:
- 既存のOCRエンジンには影響なし
- 新しいエンジンとして追加するため後方互換性を保つ

## 実装手順

1. ✓ 実装計画ドキュメントの作成（本ファイル）
2. ✓ 依存関係の追加（requirements.txt）
3. ✓ 設定クラスの追加（settings.py）
4. ✓ Geminiエンジン本体の実装（gemini_engine.py）
5. ✓ OCR Factoryへの登録
6. ✓ __init__.pyの更新
7. ✓ 設定ファイル例の更新
8. ✓ テストコードの作成
9. ✓ 動作確認（全16テスト合格）

## 期待される効果

- **精度向上**: AI言語モデルによる高精度な文字認識
- **柔軟性**: プロンプトのカスタマイズによる出力形式の調整
- **コスト**: Vision APIと比較して低コスト
- **保守性**: 既存アーキテクチャとの統合により保守が容易

## 注意事項

- Gemini API Keyの管理（環境変数推奨）
- APIレート制限への対応
- 画像サイズの制限（必要に応じてリサイズ）
- コスト管理（大量処理時の課金）

## 参考リンク

- Gemini API Documentation: https://ai.google.dev/docs
- google-generativeai Python SDK: https://github.com/google/generative-ai-python

---

## 実装完了サマリー

### 実装日時
2025-12-01

### 実装内容

#### 1. 追加されたファイル
- `src/ocr/gemini_engine.py` - Gemini OCRエンジンの実装 (302行)
- `tests/test_gemini_engine.py` - ユニットテスト (244行、16テストケース)

#### 2. 更新されたファイル
- `requirements.txt` - `google-generativeai>=0.3.0` を追加
- `src/config/settings.py` - `GeminiSettings` クラスと `OCRSettings.gemini` フィールドを追加
- `src/ocr/__init__.py` - `GeminiEngine` をエクスポート
- `config/config.example.yaml` - Gemini設定セクションを追加

#### 3. テスト結果
```
16 passed in 0.24s
```

全てのテストケースが合格:
- 初期化テスト (4件)
- 利用可能性チェックテスト (4件)
- initializeメソッドテスト (2件)
- テキスト抽出テスト (4件)
- レイアウト抽出テスト (1件)
- クローズテスト (1件)

### 使用方法

#### 1. APIキーの取得
1. Google AI Studioにアクセス: https://aistudio.google.com/app/apikey
2. APIキーを作成・取得

#### 2. 設定方法

**環境変数を使用する場合（推奨）:**
```bash
export GEMINI_API_KEY="your-api-key-here"
```

**設定ファイルを使用する場合:**
```yaml
ocr:
  primary_engine: "gemini"
  gemini:
    api_key: "your-api-key-here"
    model: "gemini-1.5-flash"
```

#### 3. 実行例
```python
from src.ocr import GeminiEngine
from PIL import Image

# エンジンの初期化
config = {"api_key": "your-api-key"}
engine = GeminiEngine(config)
engine.initialize()

# テキスト抽出
image = Image.open("page.png")
result = engine.extract_text(image)
print(result.text)
```

### 技術的特徴

1. **AI駆動のOCR**: 従来のOCRエンジンとは異なり、大規模言語モデルの理解力を活用
2. **柔軟なプロンプト**: `prompt_template` をカスタマイズして出力形式を調整可能
3. **既存アーキテクチャとの統合**: `OCRInterface` を実装し、既存のエンジンと同じインターフェース
4. **包括的なテスト**: 16のテストケースで品質を保証

### 今後の改善案

1. **レイアウト情報の抽出**: プロンプトエンジニアリングでレイアウト情報も取得
2. **バッチ処理**: 複数ページを一度に処理してコスト削減
3. **キャッシュ機能**: 同じ画像の再処理を避ける
4. **エラーリトライ**: レート制限エラーに対する自動リトライ
5. **コスト追跡**: API使用量とコストのモニタリング機能
