# 2025-12-09

## 実施内容

GitHub Actions + Google Gemini API を使った AI による自動ソースレビュー環境の構築

### 目的・背景

プロジェクトの品質向上と開発効率化のため、Pull Request 作成時に AI（Google Gemini）が自動的にコードレビューを行い、コメントを投稿する仕組みを構築する。

### 実装プラン

#### 1. 全体アーキテクチャ

```
Pull Request 作成
    ↓
GitHub Actions トリガー
    ↓
変更ファイルの取得
    ↓
Gemini API でコード分析
    ↓
レビューコメントを PR に投稿
```

#### 2. 実装するファイル

##### 2.1 GitHub Actions ワークフロー
**ファイル**: `.github/workflows/ai-code-review.yml`

**責務**:
- PR 作成・更新時にトリガー
- 変更されたファイルの取得
- Python スクリプトの実行
- レビュー結果の PR への投稿

**主な処理フロー**:
1. PR の差分を取得（`git diff` または GitHub API）
2. レビュースクリプトを実行
3. 結果を PR にコメント投稿

##### 2.2 AI レビュースクリプト
**ファイル**: `scripts/ai_code_reviewer.py`

**責務**:
- Gemini API との通信
- コードの分析・レビュー実行
- レビュー結果の整形

**主な機能**:
- ファイル差分の読み込み
- Gemini API へのリクエスト送信
- レビュー観点の定義（バグ、セキュリティ、パフォーマンス、ベストプラクティス）
- レビュー結果の JSON/Markdown 形式での出力
- 使用モデル: `gemini-2.0-flash-exp`

##### 2.3 レビュー設定ファイル（オプション）
**ファイル**: `.github/ai-review-config.yaml`

**内容**:
- レビュー対象ファイルのパターン（include/exclude）
- レビュー観点の重視度
- レビューの詳細度設定
- 除外するルール

#### 3. 必要な環境変数・Secrets

GitHub Secrets に以下を登録:
- `GEMINI_API_KEY`: Google Gemini API キー（[https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)で取得）
- `GITHUB_TOKEN`: PR コメント投稿用（自動で提供される）

#### 4. Gemini API プロンプト設計

**レビュー指示プロンプト**:
```
あなたは経験豊富なコードレビュアーです。
以下のコード変更をレビューし、下記の観点でコメントしてください：

1. バグの可能性
2. セキュリティ脆弱性
3. パフォーマンス問題
4. コードの可読性・保守性
5. Pythonベストプラクティス

重要な問題のみを指摘し、建設的なフィードバックを提供してください。
```

#### 5. レビューコメントのフォーマット

```markdown
## 🤖 AI Code Review

### 📊 Summary
- Files reviewed: X
- Issues found: Y

### 🔍 Findings

#### [ファイル名]
**Severity**: High/Medium/Low
**Line**: XX-YY
**Issue**: [問題の説明]
**Suggestion**: [改善提案]

---
Powered by Google Gemini API (gemini-2.0-flash-exp)
```

#### 6. 実装の段階

**Phase 1: 基本実装**
1. ワークフローファイル作成
2. 基本的な Python スクリプト作成
3. 単純な差分取得とレビュー実行
4. PR へのコメント投稿

**Phase 2: 機能拡張**
1. レビュー設定ファイルの導入
2. ファイル種別による除外設定
3. レビュー結果のキャッシュ
4. 重複コメントの防止

**Phase 3: 最適化**
1. レビュー速度の改善（並列処理）
2. トークン使用量の最適化
3. レビュー品質の向上（プロンプト改善）
4. ダッシュボード・統計機能

#### 7. コスト見積もり

- Gemini API 使用料: 無料枠あり（月間リクエスト制限）
- gemini-2.0-flash-exp: 高速で無料枠が大きい
- 大規模 PR でも問題なく処理可能

#### 8. セキュリティ考慮事項

- API キーは必ず Secrets で管理
- レビュー対象に機密情報を含めない（.env, credentials など除外）
- Private リポジトリでのみ使用を推奨
- API リクエストのレート制限対応

### 次に実施する予定のタスク

1. `.github/workflows/ai-code-review.yml` の作成
2. `scripts/ai_code_reviewer.py` の作成
3. 必要な依存関係を `requirements.txt` に追加
4. テスト用 PR でのテスト実行
5. ドキュメント（README）への使用方法追加

### その他メモ

- Google Gemini 2.0 Flash Exp を使用（高速・無料・高品質）
- Claude APIからGemini APIに変更（コスト削減のため）
- 最初は小規模な PR でテストを実施
- レビューの質を確認しながらプロンプトを調整
- Gemini APIは無料枠が大きいため、コスト面で有利
