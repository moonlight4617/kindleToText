# Kindle書籍OCR自動化ワークフロー 要件定義書

## 1. プロジェクト概要

### 1.1 目的
Kindle for PCで表示される書籍を自動的にスクリーンショット撮影し、OCR解析によってテキスト化する。生成されたテキストファイルをNotebookLMにインポートし、書籍の要約やQAを実施する。

### 1.2 スコープ
- Kindle for PCアプリからの自動スクリーンショット撮影
- 撮影画像のOCR処理によるテキスト抽出
- NotebookLMへインポート可能な形式でのテキスト出力

## 2. システム要件

### 2.1 実行環境
- **デバイス**: PC (Windows)
- **処理方式**: ローカル環境でのリアルタイム処理
- **ネットワーク**: オフライン処理を想定

### 2.2 ソフトウェア要件
- **Kindleアプリ**: Kindle for PC
- **OCRエンジン**:
  - 第一優先: Yomitoku (https://kotaro-kinoshita.github.io/yomitoku/installation/)
  - フォールバック: Tesseract OCR
- **プログラミング言語**: Python (推奨)

## 3. 機能要件

### 3.1 スクリーンショット撮影機能
- **自動撮影**: Kindle for PCの画面を自動的にキャプチャ
- **ページ送り**: 自動的に次ページへ遷移
- **対象ページ数**: 1冊あたり300〜500ページ
- **保存形式**: PNG/JPGなどの一般的な画像形式
- **画像保存**: すべてのスクリーンショット画像を保存（処理後も削除しない）

#### 実装検討事項
- Kindle for PCウィンドウの検出
- キャプチャ範囲の自動認識（本文領域の特定）
- ページ送りの自動化（キーボード操作のエミュレーション）
- キャプチャ間隔の制御
- 画像ファイルの命名規則と管理

### 3.2 画像前処理機能
- **必須処理**:
  - ノイズ除去
  - コントラスト調整
  - 傾き補正
  - トリミング（余白除去）
  - 二値化処理

### 3.3 OCR処理機能
- **OCRエンジン**: Yomitoku
  - 日本語テキストの高精度認識
  - オフライン動作
  - フォールバック: Tesseract OCR（Yomitoku使用不可時）
- **処理対象**: 前処理済み画像
- **リアルタイム処理**: 撮影後即座にOCR実行
- **精度優先**: 処理速度よりもOCR精度を優先
  - 画像前処理の最適化
  - OCRパラメータのチューニング
  - 必要に応じて複数回のOCR試行

### 3.4 テキスト出力機能
- **出力形式**: プレーンテキスト (.txt)
- **文字エンコーディング**: UTF-8
- **構造化**:
  - 章立て・見出しの認識（可能な範囲で）
  - 段落の区切り保持
  - ページ番号管理: 不要

#### 見出し認識の実装方針
- フォントサイズの違いによる見出し判定
- 行の位置・レイアウトによる判定
- OCR結果のメタデータ活用

### 3.5 中断・再開機能
- **処理状態の保存**:
  - 処理済みページ数の記録
  - 中断時点の状態ファイル保存
  - 既に抽出済みのテキストデータの保持
- **再開機能**:
  - 前回の中断位置から処理を再開
  - スキップ済みページの管理
  - 重複処理の防止
- **状態ファイル**: JSON形式で進捗情報を保存
  - 書籍タイトル
  - 処理開始日時
  - 現在のページ位置
  - 処理済みページリスト

#### 実装検討事項
- 定期的な状態保存（例：10ページごと）
- エラー発生時の自動状態保存
- 再開時の整合性チェック

### 3.6 書籍情報入力機能
- **書籍タイトル**: ユーザーによる手動入力
- **入力タイミング**: 処理開始前
- **利用用途**:
  - 出力ファイル名の生成
  - ログファイル名の生成
  - 状態ファイル名の生成
- **入力検証**:
  - ファイル名として使用不可な文字のチェック
  - 空白入力の防止

### 3.7 NotebookLM連携
- **インポート形式**: プレーンテキストファイル
- **特定要件**: なし
- **出力ファイル**: 1書籍につき1テキストファイル

## 4. 非機能要件

### 4.1 処理性能
- **処理優先度**: 精度優先（速度 < 精度）
  - OCR精度を最大化するための画像処理
  - 高品質なテキスト抽出を優先
- **処理方式**: リアルタイム処理（撮影→OCR→保存の連続実行）
- **安定性**: 300〜500ページの連続処理に対応
- **耐障害性**: 中断・再開機能による長時間処理の安定化

### 4.2 ユーザビリティ
- **操作性**: 最小限の操作で処理開始可能
  - 書籍タイトルの入力
  - 開始・終了ページの指定（オプション）
  - 処理開始ボタン
- **進捗表示**: 処理状況の可視化
  - 現在のページ番号
  - 処理済みページ数 / 総ページ数
  - 推定残り時間
  - 処理状態（撮影中、OCR中、保存中など）
- **エラーハンドリング**: 処理失敗時の適切な通知と復旧
  - エラー内容の詳細表示
  - 中断・再開オプションの提示
  - スキップして続行オプション

### 4.3 保守性
- **設定ファイル**: キャプチャ範囲、OCR設定などを外部ファイルで管理
- **ログ出力**: 処理履歴とエラーログの記録

## 5. 制約事項

### 5.1 処理範囲
- 1書籍ごとの個別処理（複数書籍の同時処理は対象外）
- ページ番号の自動管理は不要

### 5.2 技術的制約
- オフライン環境での動作必須
- Kindle for PC の仕様に依存

## 6. 想定ワークフロー

### 6.1 初回処理時
```
1. ユーザーがKindle for PCで書籍を開く
2. ワークフローツールを起動
3. 書籍タイトルを手動入力
4. 設定確認（開始ページ、終了ページなど）
5. 処理開始
   ├─ スクリーンショット撮影・保存
   ├─ 画像前処理（精度優先の最適化）
   ├─ OCR処理（高精度設定）
   ├─ テキスト保存（随時追記）
   ├─ 状態ファイル更新（定期的）
   └─ 次ページへ遷移（繰り返し）
6. 処理完了
7. 生成されたテキストファイルをNotebookLMへインポート
8. NotebookLMで要約・QA実施
```

### 6.2 中断・再開時
```
1. ユーザーがKindle for PCで書籍を開く（前回の続き）
2. ワークフローツールを起動
3. 既存の状態ファイルを検出
4. 再開オプションの選択
5. 前回の中断位置から処理再開
   ├─ 状態ファイルから進捗読み込み
   ├─ 該当ページまで自動移動
   ├─ スクリーンショット撮影・保存
   ├─ 画像前処理
   ├─ OCR処理
   ├─ テキスト保存（既存ファイルに追記）
   ├─ 状態ファイル更新
   └─ 次ページへ遷移（繰り返し）
6. 処理完了
7. 生成されたテキストファイルをNotebookLMへインポート
8. NotebookLMで要約・QA実施
```

## 7. 出力物

### 7.1 成果物
- **スクリーンショット画像**: すべて保存（削除しない）
- **OCR処理済みテキストファイル** (.txt)
- **処理ログファイル**
- **状態ファイル** (.json): 処理進捗の記録

### 7.2 ファイル命名規則
- **テキストファイル**: `{書籍タイトル}_{日付}.txt`
- **スクリーンショット**: `{書籍タイトル}_page_{連番}.png`
- **ログファイル**: `log_{書籍タイトル}_{日付}.log`
- **状態ファイル**: `state_{書籍タイトル}.json`

### 7.3 ディレクトリ構成
```
output/
├── {書籍タイトル}/
│   ├── screenshots/
│   │   ├── {書籍タイトル}_page_001.png
│   │   ├── {書籍タイトル}_page_002.png
│   │   └── ...
│   ├── {書籍タイトル}_{日付}.txt
│   ├── log_{書籍タイトル}_{日付}.log
│   └── state_{書籍タイトル}.json
```

## 8. 今後の拡張可能性

- 複数書籍のバッチ処理対応
- ページ番号管理機能の追加
- 目次の自動抽出
- 図表の認識とスキップ機能
- PDF出力対応
- クラウドストレージへの自動アップロード

## 9. リスクと対策

| リスク | 対策 |
|--------|------|
| Kindle for PCの仕様変更 | ウィンドウ検出ロジックの柔軟な設定 |
| OCR精度の低下 | 画像前処理の最適化、複数OCRエンジンの併用 |
| 長時間処理による不安定化 | 定期的な中断・再開機能の実装 |
| 著作権上の問題 | 個人利用の範囲内での使用に限定 |

## 10. 補足事項

### 10.1 著作権について
本ツールは個人が購入した書籍を個人的に利用する目的でのみ使用すること。第三者への配布や商用利用は禁止。

### 10.2 Yomitokuについて
- インストール: https://kotaro-kinoshita.github.io/yomitoku/installation/
- 日本語文書に特化したOCRエンジン
- オフライン動作可能
